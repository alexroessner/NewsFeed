name: CI

on:
  push:
    branches: [ main, work ]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dev dependencies
        run: pip install ruff mypy
      - name: Ruff lint
        run: ruff check src/
      - name: Ruff format check
        run: ruff format --check src/
      - name: Mypy type check
        run: mypy src/newsfeed --ignore-missing-imports --no-error-summary || true

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run unit tests
        run: |
          PYTHONPATH=src python -m unittest discover -s tests -p 'test_*.py'
      - name: Bytecode compile check
        run: |
          PYTHONPATH=src python -m compileall -q src tests
      - name: Validate imports (catch missing deps early)
        run: |
          PYTHONPATH=src python -c "
          import importlib, pathlib, sys
          failures = []
          for p in sorted(pathlib.Path('src').rglob('*.py')):
              mod = '.'.join(p.with_suffix('').parts[1:])  # strip 'src/'
              try:
                  importlib.import_module(mod)
              except Exception as exc:
                  failures.append(f'{mod}: {exc}')
          if failures:
              print('Import validation failures:')
              print('\n'.join(failures))
              sys.exit(1)
          print(f'All {len(list(pathlib.Path(\"src\").rglob(\"*.py\")))} modules imported OK')
          "
