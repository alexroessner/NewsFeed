version: "3.8"

# Staging environment â€” isolated from production
# Uses separate D1 database and Telegram bot

services:
  newsfeed-staging:
    build:
      context: ../../
      dockerfile: Dockerfile
    container_name: newsfeed-staging
    restart: unless-stopped
    environment:
      # Staging-specific configuration
      - NEWSFEED_ENV=staging
      - NEWSFEED_LOG_JSON=1
      # Separate staging bot token (create a separate bot via BotFather)
      - TELEGRAM_BOT_TOKEN=${STAGING_TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_OWNER_ID=${TELEGRAM_OWNER_ID:-}
      # Separate D1 database for staging
      - CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT_ID:-}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN:-}
      - D1_DATABASE_ID=${STAGING_D1_DATABASE_ID:-}
      # LLM keys (can share with prod or use separate)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      # Health check on different port
      - HEALTH_PORT=8081
    volumes:
      - staging-state:/app/state
    mem_limit: 256m
    cpus: "0.5"
    ports:
      - "8081:8081"
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

volumes:
  staging-state:
